<!-- checkout.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Checkout Page</title>
    <link rel="stylesheet" href="styles.css">
    <script src="cart.js"></script>
</head>

<body class="cartbody">
    <!-- back to cart -->
    

    <header>
        <br>
        <a href="index.html" class="back-button">Back to Cart</a>
        <h1>Checkout</h1>
    </header>

    <!-- shipping information form-->
    <form class="cart-form" id="cartForm">
        
        <label for="address">Shipping address:</label>
        <input type="address" id="address" name="address" required>

        <label for="card">Card number:</label>
        <input type="card" id="card" name="card" required>

        <label for="name">Name on card:</label>
        <input type="text" id="name" name="name" required>

        <label for="code">Security code:</label>
        <input type="code" id="code" name="code" required>

        <input type="submit" value="Submit">
    </form>

    <!-- Display total amount -->
    <div>
        <h1 style="font-size: 70px;">Total Amount: </h1>
        <h1 class="totalAmount">$0</h1>
    </div>

    <script>
        // Retrieve total amount from local storage
        const totalAmount = localStorage.getItem('totalAmount');
        // Update the total amount element with the retrieved value
        document.querySelector('.totalAmount').innerText = `$${totalAmount}`;

        document.getElementById('cartForm').addEventListener('submit', function (event) {
            event.preventDefault();
            // Calculate points based on total amount
            let points = calculatePoints(totalAmount);
            //update points
            updateProfilePoints(points);
        });

        // Function to calculate points based on total amount spent
        function calculatePoints(totalAmount) {
            let points = 0;
            totalAmount = parseFloat(totalAmount.replace('$', '')); // Remove $ sign
            if (totalAmount >= 50 && totalAmount < 100) {
                points = 30;
            } else if (totalAmount >= 100 && totalAmount < 300) {
                points = 90;
            } else if (totalAmount >= 300 && totalAmount < 500) {
                points = 150;
            } else if (totalAmount >= 500) {
                points = 300;
            }
            return points;
        }

        // Function to update profile points in local storage
        function updateProfilePoints(addPoints) {

            //get current points from db
            const apiUrl = 'https://login-dec3.restdb.io/rest/user-login?q={"username": "'
                                        +JSON.parse(localStorage.getItem("UserData")).username+'"}';
            const apiKey = '65b79ba7f38b576c3fcb4028';
            const usernameElement = document.getElementById('username');
            const emailElement = document.getElementById('email');
            const contactElement = document.getElementById('contact');
            const pointsElement = document.getElementById('points');

            // Fetch user profile
            fetch(`${apiUrl}`, {
                headers: {
                    'Content-Type': 'application/json',
                    'x-apikey': apiKey,
                    "Cache-Control": "no-cache"
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Display user information
                const points = data[0].points;
                
                // Display points
                if (points == null) {
                    points=0    
                } else {
                    console.error('Points not found in local storage');
                }

                //add points
                newPoints=points+addPoints;

                //update db
                const updateAPIUrl = 'https://login-dec3.restdb.io/rest/user-login/'+data[0]._id;
                fetch(`${updateAPIUrl}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-apikey': apiKey,
                        "Cache-Control": "no-cache"
                    },
                    body: JSON.stringify({
                        points: newPoints,
                    }),
                }).then(response => {
                    if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                }).then(data => {
                    if (data.points==newPoints) {
                        
                        //empty cart
                        localStorage.setItem('cart', "");

                        //goto rewards page
                        window.location.href = 'rewards.html?points='+addPoints; 
                    }
                })

            }).catch(error => console.error('Error fetching user profile:', error));
 

        }
    </script>
</body>
</html>
