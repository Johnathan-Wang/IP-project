<!DOCTYPE html>
<html lang="en">
<head>
    <title>User Profile</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>User Profile</h1>
    </header>

    <!-- navbar -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <div class="navbar">
        <a href="index.html"><i class="fa fa-fw fa-home"></i></a>
        <a href="search.html"><i class="fa fa-fw fa-search"></i></a>
        <a href="profile.html"><i class="fa fa-fw fa-user"></i></a>
        <a href="contact.html"><i class="fa fa-fw fa-envelope"></i></a>
    </div>
    
    <div class="profile-container">
        <div style="font-size: 50px;">
            <strong>Username:</strong> <span id="username"></span>
        </div>

        <div style="font-size: 50px;">
            <strong>Full Name:</strong> <span id="fullname"></span>
        </div>

        <div style="font-size: 50px;">
            <strong>Email:</strong> <span id="email"></span>
        </div>

        <div style="font-size: 50px;">
            <strong>Contact Number:</strong> <span id="contact"></span>
        </div>

        <div style="font-size: 50px;">
            <strong>Points:</strong> <span id="points"></span> <span id="tier"></span>
        </div>

        <button id="view-rewards" style="font-size: 50px; "><a style="color: white;">View Rewards</a></button>

        <hr>

        <label for="username">New Name:</label>
        <input type="text" id="new-name">

        <label for="email">New Email:</label>
        <input type="email" id="new-email">

        <label for="contact">New Contact Number:</label>
        <input type="tel" id="new-contact">

        <button id="save-button" style="font-size: 50px;">Save Changes</button>
        <br>
        <br>
        <button id="logout-button" style="font-size: 50px;">Logout</button>
    </div>

    <!-- Update the way points are calculated and displayed -->
    <!-- Update the script to fetch and display user profile -->
    <script>
        const apiKey = '65b79ba7f38b576c3fcb4028';
        const usernameElement = document.getElementById('username');
        const fullnameElement = document.getElementById('fullname');
        const emailElement = document.getElementById('email');
        const contactElement = document.getElementById('contact');
        const pointsElement = document.getElementById('points');
        const tierElement = document.getElementById('tier');

        document.addEventListener('DOMContentLoaded', function () {
            // API URL
            const apiUrl = 'https://login-dec3.restdb.io/rest/user-login?q={"username": "'
                                +JSON.parse(localStorage.getItem("UserData")).username+'"}';

            // Fetch user profile
            fetch(`${apiUrl}`, {
                headers: {
                    'Content-Type': 'application/json',
                    'x-apikey': apiKey,
                    "Cache-Control": "no-cache"
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Display user information
                usernameElement.textContent = data[0].username;
                fullnameElement.textContent = data[0].name;
                emailElement.textContent = data[0].email;
                contactElement.textContent = data[0].contact;

                // Retrieve points from local storage
                const points = data[0].points;
                
                // Display points
                if (points !== null) {
                    pointsElement.textContent = points;

                    // Calculate and display tier
                    let tier = '';
                    if (points >= 10000) {
                        tier = 'Gold';
                    } else if (points >= 5000) {
                        tier = 'Silver';
                    } else if (points >= 1000) {
                        tier = 'Bronze';
                    } else {
                        tier = 'Regular';
                    }
                    tierElement.textContent = `(${tier})`;
                } else {
                    console.error('Points not found in local storage');
                }
            })
            .catch(error => console.error('Error fetching user profile:', error));

            document.getElementById('save-button').addEventListener('click', function () {
                updateProfile(); 
            });

        });

        function updateProfile() {
          const newName = document.getElementById('new-name').value;
          const newEmail = document.getElementById('new-email').value;
          const newContact = document.getElementById('new-contact').value;

          // update user information
          const updateAPIUrl = 'https://login-dec3.restdb.io/rest/user-login/'+JSON.parse(localStorage.getItem("UserData"))._id;
          fetch(`${updateAPIUrl}`, {
              method: 'PUT',
              headers: {
                  'Content-Type': 'application/json',
                  'x-apikey': apiKey,
                  "Cache-Control": "no-cache"
              },
              body: JSON.stringify({
                  name: newName,
                  email: newEmail,
                  contact: newContact,
              }),
          })
          .then(response => {
              if (!response.ok) {
                  throw new Error(`HTTP error! Status: ${response.status}`);
              }
              return response.json();
          })
          .then(data => {
              // updates the displayed user information
              fullnameElement.textContent = data.name;
              emailElement.textContent = data.email;
              contactElement.textContent = data.contact;

              // empties input fields
              document.getElementById('new-name').value = '';
              document.getElementById('new-email').value = '';
              document.getElementById('new-contact').value = '';

              console.log('User profile updated successfully:', data);
          }).catch(error => console.error('Error updating user profile:', error));
      }

        document.getElementById('logout-button').addEventListener('click', function () {
            // remove user data from local storage
            localStorage.removeItem('UserData');
            localStorage.setItem('cart', "");
            // redirect to login page
            window.location.href = 'login.html';
        });

        document.getElementById('view-rewards').addEventListener('click', function () {
            const points = pointsElement.textContent; // Retrieve points from the displayed element
            if (points) {
                window.location.href = `tierrewards.html?points=${points}`;
            } else {
                console.error('Points not found');
            }
        });

    </script>


</body>
</html>
